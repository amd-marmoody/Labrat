#!/usr/bin/env bash
# ============================================================================
# LabRat Atuin Theme Switcher
# Switch between atuin color themes
# ============================================================================

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

ATUIN_CONFIG_DIR="${HOME}/.config/atuin"
ATUIN_CONFIG_FILE="${ATUIN_CONFIG_DIR}/config.toml"
ATUIN_THEME_DIR="${ATUIN_CONFIG_DIR}/themes"

# Get script directory (for finding labrat themes)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LABRAT_DIR="$(dirname "$SCRIPT_DIR")"
LABRAT_THEME_DIR="${LABRAT_DIR}/configs/atuin/themes"

show_help() {
    cat << EOF
${BOLD}atuin-theme${NC} - Switch atuin color themes

${BOLD}USAGE:${NC}
    atuin-theme [THEME_NAME]
    atuin-theme --list
    atuin-theme --current
    atuin-theme --help

${BOLD}OPTIONS:${NC}
    --list, -l      List available themes
    --current, -c   Show current theme
    --help, -h      Show this help

${BOLD}AVAILABLE THEMES:${NC}
    Catppuccin:
        catppuccin-mocha     Dark warm theme
        catppuccin-latte     Light theme
        catppuccin-frappe    Dark muted theme
        catppuccin-macchiato Dark blue theme
    
    Gruvbox:
        gruvbox-dark         Retro dark theme
        gruvbox-light        Retro light theme
    
    Built-in:
        default              Atuin default
        autumn               Warm colors
        marine               Blue/green colors

${BOLD}EXAMPLES:${NC}
    atuin-theme catppuccin-mocha
    atuin-theme gruvbox-dark
    atuin-theme --list
EOF
}

get_current_theme() {
    if [[ -f "$ATUIN_CONFIG_FILE" ]]; then
        grep -E '^name\s*=' "$ATUIN_CONFIG_FILE" | sed 's/.*=\s*"\?\([^"]*\)"\?.*/\1/' | tail -1 || echo "default"
    else
        echo "default"
    fi
}

list_themes() {
    local current_theme
    current_theme=$(get_current_theme)
    
    echo -e "${BOLD}Available atuin themes:${NC}\n"
    
    echo -e "${CYAN}Catppuccin:${NC}"
    for theme in catppuccin-mocha catppuccin-latte catppuccin-frappe catppuccin-macchiato; do
        local desc=""
        case "$theme" in
            catppuccin-mocha) desc="Dark warm theme" ;;
            catppuccin-latte) desc="Light theme" ;;
            catppuccin-frappe) desc="Dark muted theme" ;;
            catppuccin-macchiato) desc="Dark blue theme" ;;
        esac
        if [[ "$theme" == "$current_theme" ]]; then
            echo -e "  ${GREEN}●${NC} ${BOLD}${theme}${NC} - ${desc} ${GREEN}(current)${NC}"
        else
            echo -e "  ○ ${theme} - ${desc}"
        fi
    done
    
    echo -e "\n${CYAN}Gruvbox:${NC}"
    for theme in gruvbox-dark gruvbox-light; do
        local desc=""
        case "$theme" in
            gruvbox-dark) desc="Retro dark theme" ;;
            gruvbox-light) desc="Retro light theme" ;;
        esac
        if [[ "$theme" == "$current_theme" ]]; then
            echo -e "  ${GREEN}●${NC} ${BOLD}${theme}${NC} - ${desc} ${GREEN}(current)${NC}"
        else
            echo -e "  ○ ${theme} - ${desc}"
        fi
    done
    
    echo -e "\n${CYAN}Built-in:${NC}"
    for theme in default autumn marine; do
        local desc=""
        case "$theme" in
            default) desc="Atuin default colors" ;;
            autumn) desc="Warm fall colors" ;;
            marine) desc="Blue/green ocean theme" ;;
        esac
        if [[ "$theme" == "$current_theme" ]]; then
            echo -e "  ${GREEN}●${NC} ${BOLD}${theme}${NC} - ${desc} ${GREEN}(current)${NC}"
        else
            echo -e "  ○ ${theme} - ${desc}"
        fi
    done
}

set_theme() {
    local theme_name="$1"
    
    # Ensure config directory exists
    mkdir -p "$ATUIN_CONFIG_DIR"
    mkdir -p "$ATUIN_THEME_DIR"
    
    # Check if theme file exists (for custom themes)
    local builtin_themes=("default" "autumn" "marine")
    local is_builtin=false
    for builtin in "${builtin_themes[@]}"; do
        if [[ "$theme_name" == "$builtin" ]]; then
            is_builtin=true
            break
        fi
    done
    
    if [[ "$is_builtin" == "false" ]]; then
        # Check if theme exists in user theme dir
        if [[ ! -f "${ATUIN_THEME_DIR}/${theme_name}.toml" ]]; then
            # Try to copy from labrat themes
            if [[ -f "${LABRAT_THEME_DIR}/${theme_name}.toml" ]]; then
                cp "${LABRAT_THEME_DIR}/${theme_name}.toml" "${ATUIN_THEME_DIR}/${theme_name}.toml"
                echo -e "${GREEN}Copied theme from LabRat: ${theme_name}${NC}"
            else
                echo -e "${RED}Error: Theme '${theme_name}' not found${NC}"
                echo -e "Available themes: catppuccin-mocha, catppuccin-latte, catppuccin-frappe, catppuccin-macchiato, gruvbox-dark, gruvbox-light, default, autumn, marine"
                return 1
            fi
        fi
    fi
    
    # Update config file
    if [[ -f "$ATUIN_CONFIG_FILE" ]]; then
        # Check if [theme] section exists
        if grep -q '^\[theme\]' "$ATUIN_CONFIG_FILE"; then
            # Update existing name line under [theme] section
            sed -i '/^\[theme\]/,/^\[/ { s/^name\s*=.*/name = "'"$theme_name"'"/ }' "$ATUIN_CONFIG_FILE"
        else
            # Add [theme] section
            echo -e "\n[theme]\nname = \"${theme_name}\"" >> "$ATUIN_CONFIG_FILE"
        fi
    else
        # Create minimal config
        cat > "$ATUIN_CONFIG_FILE" << EOF
# Atuin configuration
# https://docs.atuin.sh/cli/configuration/config/

[theme]
name = "${theme_name}"
EOF
    fi
    
    echo -e "${GREEN}✓${NC} Atuin theme set to: ${BOLD}${theme_name}${NC}"
    echo -e "${YELLOW}Note:${NC} Theme changes take effect on the next atuin search (Ctrl+R)"
}

# Main
case "${1:-}" in
    --help|-h|"")
        if [[ -z "${1:-}" ]]; then
            list_themes
        else
            show_help
        fi
        ;;
    --list|-l)
        list_themes
        ;;
    --current|-c)
        current=$(get_current_theme)
        echo -e "Current atuin theme: ${BOLD}${current}${NC}"
        ;;
    *)
        set_theme "$1"
        ;;
esac
